name: Build & publish shinylive apps

on:
  push:
    branches: [ "main", "master" ]   # run whenever you push to main or master

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      RENV_CONFIG_AUTOLOADER_ENABLED: "FALSE"
      RSPM: https://packagemanager.posit.co/cran/latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: false

      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      - name: Install R packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::shinylive
          cache: true

      - name: Verify shinylive
        run: Rscript -e '.libPaths(); packageVersion("shinylive"); sessionInfo()'

      - name: Export apps
        env:
          REPO: ${{ github.event.repository.name }}
        run: |
            Rscript -e 'shinylive::export(
              "shiny-apps/mrna", "docs/apps/mrna",
               base_href = paste0("/", Sys.getenv("REPO"), "/apps/mrna/"),
               service_worker = FALSE
              )'
            Rscript -e 'shinylive::export(
              "shiny-apps/omic", "docs/apps/omic",
              base_href = paste0("/", Sys.getenv("REPO"), "/apps/omic/"),
              service_worker = FALSE
             )'
      # === New step 1 (from #5): fail loudly if key files are missing ===
      - name: Verify exported files exist
        run: |
          test -f docs/.nojekyll || (echo "Missing docs/.nojekyll" && exit 2)
          test -f docs/apps/mrna/index.html || (echo "Missing mrna index.html" && exit 2)
          test -f docs/apps/omic/index.html || (echo "Missing omic index.html" && exit 2)

      # === New step 2 (from #5): show what will be served ===
      - name: Show docs tree
        run: |
          echo "::group::docs/"
          ls -la docs
          echo "::endgroup::"
          echo "::group::docs/apps/"
          ls -la docs/apps || true
          echo "::endgroup::"
          echo "::group::docs/apps/mrna/"
          ls -la docs/apps/mrna | sed -n '1,120p' || true
          echo "::endgroup::"
          echo "::group::docs/apps/omic/"
          ls -la docs/apps/omic | sed -n '1,120p' || true
          echo "::endgroup::"

      - name: Ensure .nojekyll
        run: |
          mkdir -p docs
          touch docs/.nojekyll

      - name: Commit and push exports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "Update shinylive exports [skip ci]" || echo "No changes to commit"
          git push

