name: Build & publish shinylive apps

on:
  push:
    branches: [ "main" ]   # run whenever you push to main

jobs:
  build:
    runs-on: ubuntu-latest

    # environment variables visible to all steps
    env:
      RENV_CONFIG_AUTOLOADER_ENABLED: "FALSE"
      RSPM: https://packagemanager.posit.co/cran/latest

    steps:
      # 1. Check out your repo
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0        # full history for versioning
          submodules: false     # you removed submodules

      # 2. Set up R on the GitHub runner
      - name: Setup R
        uses: r-lib/actions/setup-r@v2

      # 3. Install shinylive and cache dependencies
      - name: Install R packages
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: |
            any::shinylive
          cache: true

      # 4. Verify shinylive is installed (optional sanity check)
      - name: Verify shinylive
        run: Rscript -e '.libPaths(); packageVersion("shinylive"); sessionInfo()'

      # 5. Export both apps to the docs/ directory
      - name: Export apps
        env:
          REPO: ${{ github.event.repository.name }}
        run: |
          Rscript -e 'shinylive::export("shiny-apps/mrna", "docs/apps/mrna",
                                        base_href = paste0("/", Sys.getenv("REPO"), "/apps/mrna/"))'
          Rscript -e 'shinylive::export("shiny-apps/omic", "docs/apps/omic",
                                        base_href = paste0("/", Sys.getenv("REPO"), "/apps/omic/"))'

      # 6. Make sure GitHub Pages ignores Jekyll
      - name: Ensure .nojekyll
        run: |
          mkdir -p docs
          touch docs/.nojekyll

      # 7. Commit and push the exported files back to the repo
      - name: Commit and push exports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs
          git commit -m "Update shinylive exports [skip ci]" || echo "No changes to commit"
          git push

